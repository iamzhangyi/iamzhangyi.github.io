<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhangyi.xyz","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="需求针对某通信产品，我们需要开发一个版本升级管理系统。该系统需要通过由Java开发的管理后台，由Telnet发起向前端基站设备的命令，以获取基站设备的版本信息，并在后台比较与当前最新版本的差异，以确定执行什么样的命令对基站设备的软件文件进行操作。基站设备分为两种：  主控板（Master Board） 受控板（Slave Board）  基站设备允许执行的命令包括transfer、active、i">
<meta property="og:type" content="article">
<meta property="og:title" content="职责驱动设计以及状态模式的变化">
<meta property="og:url" content="http://zhangyi.xyz/state-pattern-and-rdd/index.html">
<meta property="og:site_name" content="张逸说">
<meta property="og:description" content="需求针对某通信产品，我们需要开发一个版本升级管理系统。该系统需要通过由Java开发的管理后台，由Telnet发起向前端基站设备的命令，以获取基站设备的版本信息，并在后台比较与当前最新版本的差异，以确定执行什么样的命令对基站设备的软件文件进行操作。基站设备分为两种：  主控板（Master Board） 受控板（Slave Board）  基站设备允许执行的命令包括transfer、active、i">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://zhangyi.xyz/state-pattern-and-rdd/01.jpg">
<meta property="og:image" content="http://zhangyi.xyz/state-pattern-and-rdd/02.png">
<meta property="og:image" content="http://zhangyi.xyz/state-pattern-and-rdd/03.png">
<meta property="og:image" content="http://zhangyi.xyz/state-pattern-and-rdd/04.png">
<meta property="article:published_time" content="2018-12-24T12:34:35.000Z">
<meta property="article:modified_time" content="2018-12-24T12:44:49.000Z">
<meta property="article:author" content="张逸">
<meta property="article:tag" content="Design">
<meta property="article:tag" content="Design Pattern">
<meta property="article:tag" content="OO">
<meta property="article:tag" content="RDD">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://zhangyi.xyz/state-pattern-and-rdd/01.jpg">

<link rel="canonical" href="http://zhangyi.xyz/state-pattern-and-rdd/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>职责驱动设计以及状态模式的变化 | 张逸说</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">张逸说</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">出口成张，逸派胡言</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhangyi.xyz/state-pattern-and-rdd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张逸">
      <meta itemprop="description" content="张逸，架构编码实践者，微服务架构设计者，领域驱动设计布道师，大数据平台架构师。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张逸说">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          职责驱动设计以及状态模式的变化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2018-12-24 20:34:35 / 修改时间：20:44:49" itemprop="dateCreated datePublished" datetime="2018-12-24T20:34:35+08:00">2018-12-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design/" itemprop="url" rel="index"><span itemprop="name">Design</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/state-pattern-and-rdd/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/state-pattern-and-rdd/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>针对某通信产品，我们需要开发一个版本升级管理系统。该系统需要通过由Java开发的管理后台，由Telnet发起向前端基站设备的命令，以获取基站设备的版本信息，并在后台比较与当前最新版本的差异，以确定执行什么样的命令对基站设备的软件文件进行操作。基站设备分为两种：</p>
<ul>
<li>主控板（Master Board）</li>
<li>受控板（Slave Board）</li>
</ul>
<p>基站设备允许执行的命令包括transfer、active、inactive等。这些命令不仅受到设备类型的限制，还要受制于该设备究竟运行在什么样的终端。类型分为：</p>
<ul>
<li>Shell</li>
<li>UShell</li>
</ul>
<p>对命令的约束条件大体如下表所示（不代表真实需求）：</p>
<img src="/state-pattern-and-rdd/01.jpg" class="">


<p>通过登录可以连接到主控板的Shell终端，此时，若执行enterUshell命令则进入UShell终端，执行enterSlaveBoard则进入受控板的Shell终端。在受控板同样可以执行enterUshell进入它的UShell终端。系统还提供了对应的退出操作。整个操作引起的变迁如下图所示：</p>
<img src="/state-pattern-and-rdd/02.png" class="">


<p>执行升级的流程是在让基站设备处于失效状态下，获取基站设备的软件版本信息，然后在后端基于最新版本进行比较。得到版本之间的差异后，通过transfer命令传输新文件，put命令更新文件，deleteFiles命令删除多余的文件。成功更新后，再激活基站设备。因此，一个典型的升级流程如下所示：<br>0. login (Master Board Shell)</p>
<ol>
<li>inactive (Master Board UShell)</li>
<li>get  (Slave Board Shell)</li>
<li>transfer(Master Board Shell)</li>
<li>put(Slave Board Shell)</li>
<li>deleteFiles(Slave Board Ushell)</li>
<li>active(Master Board UShell)</li>
<li>logout</li>
</ol>
<p>整个版本升级系统要求：无论当前基站设备属于哪种分类，处于哪种终端，只要Telnet连接没有中断，在要求升级执行的命令必须执行成功。如果当前所处的设备与终端不满足要求，系统就需要迁移到正确的状态，以确保命令的执行成功。</p>
<span id="more"></span>

<h2 id="寻找解决方案"><a href="#寻找解决方案" class="headerlink" title="寻找解决方案"></a>寻找解决方案</h2><p>根据这个需求，我们期待的客户端调用为（为简便起见，省略了所有的方法参数）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//client </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">upgrade</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TelnetService service = <span class="keyword">new</span> TelnetService();</span><br><span class="line">    service.login();</span><br><span class="line">    service.inactive();</span><br><span class="line">    service.get();</span><br><span class="line">    service.transfer();</span><br><span class="line">    service.put();</span><br><span class="line">    service.deleteFiles();</span><br><span class="line">    service.active();</span><br><span class="line">    service.logout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样简便直观的调用，实则封装了复杂的规则和转换逻辑。我们应该怎么设计才能达到这样的效果呢？</p>
<h3 id="使用条件分支"><a href="#使用条件分支" class="headerlink" title="使用条件分支"></a>使用条件分支</h3><p>一种解决方法是使用条件分支，因为对于每条Telnet命令而言，都需要判断当前的状态，以决定执行不同的操作，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TelnetService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String currentState = <span class="string">&quot;INITIAL&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        swich (currentState.toUpperCase()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;INITIAL&quot;</span>:</span><br><span class="line">                login();</span><br><span class="line">                currentState = <span class="string">&quot;MASTER_SHELL&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;MASTER_SHELL&quot;</span>:</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">                ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行transfer命令</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而这样的实现是不可接受的，因为我们需要对每条命令都要编写相似的条件分支语句，这就导致出现了重复代码。我们可以将这样的逻辑封装到一个方法中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TelnetService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String currentState = <span class="string">&quot;INITIAL&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        swichState(<span class="string">&quot;MASTER_SHELL&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行transfer命令</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">switchState</span><span class="params">(String targetState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (currentState.toUpperCase()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;INITIAL&quot;</span>:</span><br><span class="line">                <span class="keyword">switch</span> (targetState.toUpperCase()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;INITIAL&quot;</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&quot;MASTER_SHELL&quot;</span>:</span><br><span class="line">                        login();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// 其他分支略</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 其他分支略</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>switchState()</code>方法避免了条件分支的重复代码，但是它同时也加重了方法实现的复杂度，因为它需要同时针对当前状态与目标状态进行判断，这相当于是一个条件组合。</p>
<p>Kent Beck认为：“（条件分支的）所有逻辑仍然在同一个类里，阅读者不必四处寻找所有可能的计算路径。但条件语句的缺点是：除了修改对象本身的代码之外，没有其他办法修改它的逻辑。……条件语句的好处在于简单和局部化。”显然，由于条件分支的集中化，导致变化发生时，我们只需要修改这一处；但问题在于任何变化都需要对此进行修改，这实际上是重构中“发散式变化（Divergent Change）”坏味道。</p>
<h3 id="引入职责驱动设计"><a href="#引入职责驱动设计" class="headerlink" title="引入职责驱动设计"></a>引入职责驱动设计</h3><p>职责驱动设计强调从“职责”的角度思考设计。<strong>职责</strong>是“拟人化”的思考模式，这实际上是面向对象分析与设计的思维模式：将对象看作是有思想有判断有知识有能力的“四有青年”。这也就是我所谓的“智能对象”。只要分辨出职责，就可以从知识和能力的角度入手，寻找哪个对象具备履行该职责的能力？</p>
<p>回到版本升级系统这个例子，从诸如transfer、put等命令的角度思考职责，则可以识别职责为：</p>
<ul>
<li>执行Telnet命令<ul>
<li>迁移到正确的状态</li>
<li>运行Telnet命令</li>
</ul>
</li>
</ul>
<p><code>TelnetService</code>具有执行Telnet命令的能力，如果要运行的命令太多，也可以考虑将运行各个命令的职责再分派给对应的<code>Command</code>对象。那么，又该谁来执行“迁移到正确的状态”呢？看能力？——谁具有迁移状态的能力？一个对象能够履行某个职责，必须具备履行职责的知识，所以就要看知识。</p>
<p>迁移到正确状态需要哪些知识？——当前状态、目标状态以及如何迁移状态。只要确定了当前状态和目标状态，根据前面的状态变迁图就可以知道该如何迁移状态了。那么，谁确定地知道当前状态呢？——<strong>只有状态对象自身才知道！</strong>在条件分支实现中，状态是通过字符串表达的，字符串对象自身并不知道其值到底是什么，需要取出其值进行判断，这就是使用条件分支的原因。当状态从一个字符串升级为状态对象时，状态的值就是状态对象“自己知道”的知识。当每种状态都知道自己的状态值时，它们若要履行“迁移状态”的职责，就无需再对当前状态进行判断了，这正是为何多态能够替代条件分支的原因。</p>
<p>我们可以定义一个状态的继承树：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NodeState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">switchTo</span><span class="params">(???)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitialState</span> <span class="keyword">implements</span> <span class="title">NodeState</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterShellState</span> <span class="keyword">implements</span> <span class="title">NodeState</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>当状态变为对象且具有职责时，对象就是有思想的职能对象。遗憾的是，它具有的知识还不足以完全履行“迁移到正确状态”的职责，因为它并不知道该迁移到哪个目标状态。这个知识只有具体的Telnet命令才知道，因而需要传递给它。一种做法是作为方法参数传入，但这会导致方法体内需要对传入的参数作条件分支判断。另一种方法则利用方法的多态，显式地定义多种方法来履行迁移到不同目标状态的职责：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">NodeState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">switchToInitial</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">switchToMasterShell</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">switchToMasterUshell</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">switchToSlaveShell</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">switchToSlaveUshell</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitialState</span> <span class="keyword">implements</span> <span class="title">NodeState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InitialState</span><span class="params">(TelnetService service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToInitial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToMasterShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.login();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> MasterShellState(service));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToMasterUshell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.login();</span><br><span class="line">        service.enterUshell();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> MasterUshellState(service));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToSlaveShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.login();</span><br><span class="line">        service.enterSlave();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> SlaveShellState(service));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToSlaveUshell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.login();</span><br><span class="line">        service.enterSlave();</span><br><span class="line">        service.enterUshell();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> SlaveShellState(service));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterShellState</span> <span class="title">implement</span> <span class="title">NodeState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MasterShell</span><span class="params">(TelnetService service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToInitial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.logout();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> InitialState(service));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToMasterShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToMasterUshell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.enterUshell();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> MasterUshellState(service));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToSlaveShell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.enterSlave();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> SlaveShellState(service));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">switchToSlaveUshell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.enterSlave();</span><br><span class="line">        service.enterUshell();</span><br><span class="line">        service.setCurrentState(<span class="keyword">new</span> SlaveShellState(service));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TelnetService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> NodeState currentState = <span class="keyword">new</span> InitialState(<span class="keyword">this</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentState</span><span class="params">(NodeState state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.currentState = state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inactive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        currentState.switchToMasterUshell();</span><br><span class="line">        <span class="comment">//inactive impl</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        currentState.switchToMasterShell();</span><br><span class="line">        <span class="comment">//real transfer impl</span></span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">active</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        currentState.switchToMasterUshell();</span><br><span class="line">        <span class="comment">// real active impl</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        currentState.switchToSlaveShell();</span><br><span class="line">        <span class="comment">// get</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的设计并没有做到“开放封闭原则”，当增加了新的状态时，由于需要在<code>NodeState</code>接口中增加新的方法，使得所有实现该接口的状态类都需要修改。这相当于从条件分支的“发散式变化”坏味道变成了“霰弹式修改（Shotgun Surgery）”坏味道，即一个变化引起多处修改。然而比起条件分支方案而言，由于不用再判断当前状态，复杂度降低了许多，可以有效减少bug的产生。</p>
<h3 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h3><p>将一个状态进化为对象，这种设计思想是状态模式的设计。根据GOF的《设计模式》，一个标准的状态模式类图如下所示：</p>
<img src="/state-pattern-and-rdd/03.png" class="">

<p>当我们要设计的业务具有复杂的状态变迁时，往往通过状态图来表现。利用状态图，可以非常容易地将其转换为状态模式。状态图的每个状态被封装一个状态对象，所有状态对象实现同一个抽象接口。该抽象接口的方法则为状态图上触发状态迁移的命令。<code>Context</code>对象持有一个全局变量，用以保存当前状态对象。每个状态对象持有<code>Context</code>对象，通过<code>Context</code>访问全局的当前状态变量，以完成状态的迁移。具体的状态对象在实现状态接口时，倘若是不符合条件的命令，则实现为空，或者抛出异常。</p>
<p>依据状态图，可以实现为状态模式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">NodeState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enterUshell</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exitUshell</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enterSlaveBoard</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exitSlaveBoard</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitialState</span> <span class="keyword">implements</span> <span class="title">NodeState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TelnetService telnetService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InitialState</span><span class="params">(TelnetService telnetService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.telnetService = telnetService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//login</span></span><br><span class="line">        telnetService.login();</span><br><span class="line">        <span class="keyword">this</span>.telnetService.setCurrentState(<span class="keyword">new</span> MasterShellState(telnetService));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span> </span>&#123; <span class="comment">//do nothing &#125;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enterUshell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IlegalStateException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他方法略</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 其他状态对象略</span></span><br></pre></td></tr></table></figure>

<p>在实现Telnet的transfer等命令时，这一设计却未达到意料的效果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TelnetService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> NodeState currentState = <span class="keyword">new</span> InitialState();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentState</span><span class="params">(NodeState state)</span> </span>&#123;    </span><br><span class="line">        <span class="keyword">this</span>.currentState = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// currentState到底是哪个状态？</span></span><br><span class="line">        <span class="keyword">if</span> (!currentState.isMasterShell()) &#123;</span><br><span class="line">            <span class="comment">// 需要迁移到正确的状态</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// transfer implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引入了状态模式后，在<code>transfer()</code>方法中仍然需要判断当前状态，这与条件分支方案何异？是状态模式存在问题吗？非也！这实际上是应用场景的问题。让我们联想一下地铁刷卡进站的场景，该场景只有Opened和Closed两个状态，其状态迁移如下图所示：</p>
<img src="/state-pattern-and-rdd/04.png" class="">

<p>比较两个状态图。对于地铁场景，当地铁门处于Closed状态时，需要支付刷卡才能切换到Opened状态，如果不满足条件，这个状态将一直保持。也就是说，对于客户端调用者而言，合法的调用只能是<code>pay()</code>，如果调用行为是<code>pass()</code>或者<code>timeout()</code>，状态对象将不给予响应。版本升级系统则不然。当系统处于Initial状态时，系统无法限制客户端调用者只能发起正确的<code>login()</code>方法。因为提供给客户端的命令操作并非<code>login()</code>、<code>enterUShell()</code>等引起状态变迁的方法，而是transfer、put等命令。同时，需求又要求无论当前处于什么状态，执行什么命令，都要迁移到正确的状态。这正是版本升级管理系统无法按照标准状态模式进行设计的原因所在。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>如果我们熟悉状态模式，针对本文的业务场景，或许会首先想到状态模式。然而，设计模式是有应用场景的，我们不能一味蛮干，或者按照模式的套路去套用，这是会出现问题的。通过分辨职责的设计方法，同时明确所谓“智能对象”的意义，我们照样可以推导出一个好的设计。我们虽然抽象出了状态对象，但抽象的方法并非引起状态迁移的行为，而是迁移状态的行为。我们没有从设计模式开始，而是从“职责”开始对设计进行驱动，这是<strong>职责驱动设计</strong>的设计驱动力。</p>
<p>当我们引入状态智能对象时，我们并没有获得一个完全遵循开放封闭原则的设计方案。实际上，当状态发生变化时，要做到对扩展完全开放是非常困难的。即使可行，在状态变化的需求是未知的情况下，为此付出太多的设计与开发成本是没有必要的。恰如其分的设计来满足当前的需求即可。当然，我们可以考虑将抽象的状态接口修改为抽象类，这样就可以把增加新方法对实现类带来的影响降低。不过，Java 8为接口提供了默认方法，已经可以规避这个问题了。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>张逸
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://zhangyi.xyz/state-pattern-and-rdd/" title="职责驱动设计以及状态模式的变化">http://zhangyi.xyz/state-pattern-and-rdd/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Design/" rel="tag"># Design</a>
              <a href="/tags/Design-Pattern/" rel="tag"># Design Pattern</a>
              <a href="/tags/OO/" rel="tag"># OO</a>
              <a href="/tags/RDD/" rel="tag"># RDD</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/ddd-strategic-design-workshop/" rel="prev" title="领域驱动战略设计工作坊">
      <i class="fa fa-chevron-left"></i> 领域驱动战略设计工作坊
    </a></div>
      <div class="post-nav-item">
    <a href="/handling-complex-by-ddd/" rel="next" title="领域驱动设计对软件复杂度的应对">
      领域驱动设计对软件复杂度的应对 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82"><span class="nav-number">1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BB%E6%89%BE%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">2.</span> <span class="nav-text">寻找解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF"><span class="nav-number">2.1.</span> <span class="nav-text">使用条件分支</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E8%81%8C%E8%B4%A3%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.2.</span> <span class="nav-text">引入职责驱动设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.3.</span> <span class="nav-text">状态模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">3.</span> <span class="nav-text">结论</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">张逸</p>
  <div class="site-description" itemprop="description">张逸，架构编码实践者，微服务架构设计者，领域驱动设计布道师，大数据平台架构师。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/agiledon" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;agiledon" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:brucezhang@tom.com" title="E-Mail → mailto:brucezhang@tom.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张逸</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">353k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:21</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'wPVDNiDMLe1I6wcQzysBwx1G-gzGzoHsz',
      appKey     : 'xSeNJmSjwgSFbu704F1RNHze',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
